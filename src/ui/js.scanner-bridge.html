<script>
window.MiniScanner = (() => {
  let videoStream = null;
  let videoEl = null;
  let running = false;
  let mount = null;

  function ensureMount() {
    mount = document.getElementById('scannerMount');
    if (!mount) {
      mount = document.createElement('div');
      mount.id = 'scannerMount';
      mount.style.cssText = `
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.85);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        padding: 1rem;
      `;
      document.body.appendChild(mount);
    }
  }

  function createCancelButton() {
    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'Cancel';
    cancelBtn.className = 'btn secondary';
    cancelBtn.style.cssText = `
      position: absolute;
      top: 1rem;
      right: 1rem;
      font-size: 16px;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      z-index: 10000;
    `;
    cancelBtn.addEventListener('click', () => {
      stop();
      window.dispatchEvent(new CustomEvent('upc-scan-canceled'));
    });
    return cancelBtn;
  }

  async function open(){
    if (!('BarcodeDetector' in window)) {
      alert('Barcode scanning is not supported on this device or browser.\nPlease enter the UPC manually.');
      return;
    }

    try {
      const detector = new BarcodeDetector({ formats: ['ean_13'] });
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });

      ensureMount();

      videoEl = document.createElement('video');
      videoEl.setAttribute('autoplay', '');
      videoEl.setAttribute('playsinline', '');
      videoEl.style.cssText = `
        width: 100%;
        height: auto;
        max-height: 80%;
        border-radius: 16px;
        box-shadow: 0 0 20px #000;
      `;

      mount.innerHTML = ''; // clear previous contents
      mount.appendChild(videoEl);
      mount.appendChild(createCancelButton());

      videoEl.srcObject = stream;
      videoStream = stream;
      await videoEl.play();

      running = true;
      detectLoop(detector);
    } catch (err) {
      console.error('[MiniScanner.open] error:', err);
      alert('Unable to access the camera for barcode scanning.');
      window.dispatchEvent(new CustomEvent('upc-scan-canceled'));
    }
  }

  async function detectLoop(detector){
    while (running) {
      try {
        const barcodes = await detector.detect(videoEl);
        if (barcodes.length > 0) {
          const code = barcodes[0]?.rawValue?.trim() || '';
          if (/^\d{12}$/.test(code)) {
            stop();
            window.dispatchEvent(new CustomEvent('upc-scanned', { detail: { upc: code } }));
            return;
          }
        }
        await new Promise(r => setTimeout(r, 300));
      } catch (err) {
        console.warn('[MiniScanner.detectLoop] error:', err);
        break;
      }
    }

    stop();
    window.dispatchEvent(new CustomEvent('upc-scan-canceled'));
  }

  function stop(){
    running = false;
    if (videoStream) {
      videoStream.getTracks().forEach(t => t.stop());
      videoStream = null;
    }
    if (videoEl) {
      videoEl.pause();
      videoEl.srcObject = null;
    }
    if (mount) {
      mount.innerHTML = '';
      mount.remove();
      mount = null;
    }
    videoEl = null;
  }

  return { open, stop };
})();
</script>