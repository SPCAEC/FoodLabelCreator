<script>
/**
 * Scanner Bridge â€” emits events to window
 * - For native BarcodeDetector
 * - With preview + cancel support
 */

window.MiniScanner = (function(){
  let stream = null;
  let video = null;
  let active = false;
  let detector = null;
  let rafId = null;

  async function open(){
    if (!('BarcodeDetector' in window)) {
      console.warn('BarcodeDetector not supported');
      alert('Barcode scanner not supported in this browser.');
      return;
    }

    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    } catch (err) {
      console.error('Camera error:', err);
      alert('Camera access is required to scan.');
      return;
    }

    if (!video) {
      video = document.createElement('video');
      video.setAttribute('autoplay', true);
      video.setAttribute('muted', true);
      video.setAttribute('playsinline', true);
      video.style.width = '100%';
      video.style.maxHeight = '60vh';
      video.style.borderRadius = '16px';
    }

    video.srcObject = stream;

    const mount = document.getElementById('scannerMount');
    if (!mount) throw new Error('scannerMount not found');
    mount.innerHTML = '';
    mount.appendChild(video);

    const section = document.getElementById('scannerSection');
    if (section) section.classList.remove('hidden');

    if (!detector) detector = new BarcodeDetector({ formats: ['ean_13', 'upc_a'] });
    active = true;

    video.onloadedmetadata = () => {
      video.play();
      detectLoop();
    };
  }

  function stop(){
    active = false;
    if (rafId) cancelAnimationFrame(rafId);
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    if (video) video.pause();
    const section = document.getElementById('scannerSection');
    if (section) section.classList.add('hidden');
    const mount = document.getElementById('scannerMount');
    if (mount) mount.innerHTML = '';
    window.dispatchEvent(new CustomEvent('upc-scan-canceled'));
  }

  async function detectLoop(){
    if (!active || !video || video.readyState < 2) {
      rafId = requestAnimationFrame(detectLoop);
      return;
    }

    try {
      const results = await detector.detect(video);
      if (results.length) {
        const upc = results[0].rawValue;
        stop();
        window.dispatchEvent(new CustomEvent('upc-scanned', { detail: { upc } }));
        return;
      }
    } catch (err) {
      console.error('Detection error:', err);
    }

    rafId = requestAnimationFrame(detectLoop);
  }

  return { open, stop };
})();
</script>