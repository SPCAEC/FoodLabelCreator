<script>
/**
 * MiniScanner: Barcode scanner using native BarcodeDetector with live camera preview.
 * Mounts into #scannerMount and shows #scannerSection.
 */
window.MiniScanner = (() => {
  const section = document.getElementById('scannerSection');
  const mount = document.getElementById('scannerMount');
  let stream = null;
  let running = false;
  let rafId = null;
  let video = null;
  let detector = null;

  async function open(){
    if (!('BarcodeDetector' in window)) {
      alert('Barcode scanning not supported on this device.');
      return;
    }

    try {
      detector = new BarcodeDetector({ formats: ['ean_13', 'ean_8', 'upc_a', 'upc_e'] });
    } catch (err) {
      console.error('BarcodeDetector init failed:', err);
      alert('Barcode scanning not supported.');
      return;
    }

    if (!section || !mount) return;
    mount.innerHTML = '';

    video = document.createElement('video');
    video.setAttribute('autoplay', '');
    video.setAttribute('playsinline', '');
    video.style.width = '100%';
    video.style.maxHeight = '60vh';
    video.style.borderRadius = '16px';

    mount.appendChild(video);
    section.classList.remove('hidden');
    section.removeAttribute('aria-hidden');

    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
      video.srcObject = stream;

      await video.play();
      running = true;
      requestScan();
    } catch (err) {
      console.error('Camera access failed:', err);
      alert('Camera access was denied or failed.');
    }
  }

  function requestScan(){
    if (!running || !video || video.readyState < 2) {
      rafId = requestAnimationFrame(requestScan);
      return;
    }

    detector.detect(video).then(codes => {
      const code = codes?.[0]?.rawValue || '';
      if (code) {
        close();
        const event = new CustomEvent('upc-scanned', { detail: { upc: code } });
        window.dispatchEvent(event);
      } else {
        rafId = requestAnimationFrame(requestScan);
      }
    }).catch(err => {
      console.warn('Scan error:', err);
      rafId = requestAnimationFrame(requestScan);
    });
  }

  function close(){
    running = false;
    if (rafId) cancelAnimationFrame(rafId);
    if (video) {
      video.pause();
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
        video.srcObject = null;
      }
      video.remove();
    }

    if (section) {
      section.classList.add('hidden');
      section.setAttribute('aria-hidden', 'true');
    }

    const evt = new CustomEvent('upc-scan-canceled');
    window.dispatchEvent(evt);
  }

  return { open, close };
})();
</script>