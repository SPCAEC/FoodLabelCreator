<script>
/**
 * Scanner Bridge (Render mini-app, inline modal)
 * ----------------------------------------------
 * Opens: https://scannerminiapp.onrender.com/scanner.html?license=...
 * Receives: postMessage({ type:"scandit:upc", upc }) | { type:"scandit:cancel" }
 *
 * Public API:
 *   window.MiniScanner.open()       // show modal
 *   window.MiniScanner.close()      // hide modal (if needed)
 *   window.MiniScanner.origin/url   // readonly debug
 *
 * Global events your app can listen for:
 *   window.addEventListener('upc-scanned', e => e.detail.upc)
 *   window.addEventListener('upc-scan-canceled', () => ...)
 */

(function () {
  // ----- CONFIG -----
  const SCANNER_ORIGIN = "https://scannerminiapp.onrender.com";
  const SCANNER_URL    = SCANNER_ORIGIN + "/scanner.html";
  const SCANDIT_LICENSE = `<?= PropertiesService.getScriptProperties().getProperty('SCANDIT_LICENSE') || '' ?>`;

  // ----- INTERNALS -----
  const MODAL_ID = 'scannerModal';
  const CLOSE_ID = 'scannerCloseBtn';

  function buildScannerUrl() {
    const sep = SCANNER_URL.includes("?") ? "&" : "?";
    return `${SCANNER_URL}${sep}license=${encodeURIComponent(SCANDIT_LICENSE)}`;
  }

  function dispatchResult(upc) {
    window.dispatchEvent(new CustomEvent("upc-scanned", { detail: { upc } }));
  }
  function dispatchCancel() {
    window.dispatchEvent(new CustomEvent("upc-scan-canceled"));
  }

  // ----- MODAL -----
  function open() {
    // Make sure we donâ€™t duplicate the modal
    close();

    const url = buildScannerUrl();
    const wrap = document.createElement('div');
    wrap.id = MODAL_ID;
    wrap.setAttribute('role', 'dialog');
    wrap.setAttribute('aria-modal', 'true');
    wrap.style.cssText = [
      'position:fixed','inset:0','background:rgba(0,0,0,.6)',
      'display:grid','place-items:center','z-index:9999'
    ].join(';');

    wrap.innerHTML = `
      <div style="width:min(96vw,520px);height:80vh;background:#fff;border-radius:14px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.25);display:flex;flex-direction:column;">
        <div style="display:flex;justify-content:flex-end;gap:8px;align-items:center;padding:8px;background:#f8fafc;border-bottom:1px solid #e5e7eb;">
          <button id="${CLOSE_ID}" type="button" class="btn ghost" style="margin-right:8px">Close</button>
        </div>
        <iframe
          src="${url}"
          style="flex:1;width:100%;border:0"
          allow="camera *; microphone *"
          title="Barcode Scanner"
        ></iframe>
      </div>
    `;

    document.body.appendChild(wrap);
    document.getElementById(CLOSE_ID).onclick = () => {
      dispatchCancel();
      close();
    };
  }

  function close() {
    const el = document.getElementById(MODAL_ID);
    if (el) el.remove();
  }

  // ----- SECURE MESSAGE HANDLER -----
  window.addEventListener("message", (ev) => {
    if (ev.origin !== SCANNER_ORIGIN) return; // security
    const data = ev.data || {};

    if (data.type === "scandit:upc" && /^\d{12}$/.test(String(data.upc))) {
      close();
      dispatchResult(String(data.upc));
      return;
    }
    if (data.type === "scandit:cancel") {
      close();
      dispatchCancel();
      return;
    }
  });

  // ----- PUBLIC API -----
  window.MiniScanner = Object.freeze({
    open,
    close,
    get origin(){ return SCANNER_ORIGIN; },
    get url(){ return SCANNER_URL; }
  });
})();
</script>