<script>
/**
 * MiniScanner - Chrome native BarcodeDetector-based scanner
 * - Shows preview in #scannerMount
 * - Dispatches 'upc-scanned' event on detection
 * - Gracefully cleans up video + stream on cancel
 */

window.MiniScanner = (() => {
  const mount = document.getElementById('scannerMount');
  const section = document.getElementById('scannerSection');
  const stopBtn = document.getElementById('stopScanBtn');

  let video = null;
  let stream = null;
  let detector = null;
  let running = false;

  async function open() {
    if (!('BarcodeDetector' in window)) {
      alert('Barcode scanning is not supported on this device.');
      return;
    }

    // Setup UI
    section.classList.remove('hidden');
    section.removeAttribute('aria-hidden');
    mount.innerHTML = '';
    video = document.createElement('video');
    video.setAttribute('autoplay', '');
    video.setAttribute('playsinline', '');
    video.className = 'preview';
    mount.appendChild(video);

    // Get camera
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      video.srcObject = stream;
    } catch (err) {
      console.error('Camera access failed', err);
      alert('Unable to access camera.');
      return;
    }

    detector = new BarcodeDetector({ formats: ['ean_13', 'upc_a'] });
    running = true;

    requestAnimationFrame(tick);
  }

  async function tick() {
    if (!running || !video || video.readyState < 2) {
      requestAnimationFrame(tick);
      return;
    }

    try {
      const barcodes = await detector.detect(video);
      if (barcodes.length > 0) {
        const code = normalize(barcodes[0].rawValue);
        if (code) {
          close();
          window.dispatchEvent(new CustomEvent('upc-scanned', { detail: { upc: code } }));
          return;
        }
      }
    } catch (err) {
      console.error('Barcode detection error', err);
    }

    requestAnimationFrame(tick);
  }

  function normalize(raw) {
    let s = String(raw || '').replace(/\D/g, '');
    if (s.length === 13 && s[0] === '0') s = s.slice(1);
    if (s.length > 0 && s.length < 12) s = s.padStart(12, '0');
    return s.length === 12 ? s : '';
  }

  function close() {
    running = false;
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    if (video && video.srcObject) {
      video.srcObject = null;
    }
    mount.innerHTML = '';
    section.classList.add('hidden');
    section.setAttribute('aria-hidden', 'true');
    window.dispatchEvent(new CustomEvent('upc-scan-canceled'));
  }

  stopBtn?.addEventListener('click', close);

  return { open, close };
})();
</script>