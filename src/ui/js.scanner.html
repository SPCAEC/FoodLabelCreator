<script>
/**
 * Scandit Web (bundled) loader + scanner
 * - Multi-CDN (jsDelivr → unpkg) & early configure() per docs.
 * - Built-in camera with recommended settings for BarcodeCapture.
 * - Retail symbologies (EAN-13/UPC-A, EAN-8, UPC-E) registered.
 * - Listener rejects unwanted scans; accepts UPC-A & EAN-13 (leading 0) only.
 * - Exposes window.Scanner.open() -> Promise<string>, window.Scanner.close()
 */
(function () {
  const LICENSE = `<?= PropertiesService.getScriptProperties().getProperty('SCANDIT_LICENSE') || '' ?>`;

  // Bundled build (Core+Barcode in one file), matching Scandit docs
  const SOURCES = [
    {
      js: "https://cdn.jsdelivr.net/npm/scandit-web-datacapture-bundled@7.6.1/build/js/index.min.js",
      engine: "https://cdn.jsdelivr.net/npm/scandit-web-datacapture-bundled@7.6.1/build/engine/"
    },
    {
      js: "https://unpkg.com/scandit-web-datacapture-bundled@7.6.1/build/js/index.min.js",
      engine: "https://unpkg.com/scandit-web-datacapture-bundled@7.6.1/build/engine/"
    }
  ];

  // ---- tiny utils ----
  function SDK(){ return window.Scandit || null; }
  function loadScript(src){
    return new Promise((resolve, reject) => {
      const s = document.createElement('script');
      s.src = src; s.async = true;
      s.onload = () => resolve();
      s.onerror = () => reject(new Error('Failed to load: ' + src));
      document.head.appendChild(s);
    });
  }
  function isDigits12(v){ return /^\d{12}$/.test(String(v||'')); }
  function normalizeToUpcA(data){
    const s = String(data||'').trim();
    if (/^\d{12}$/.test(s)) return s;                  // UPC-A
    if (/^0\d{12}$/.test(s)) return s.slice(1);        // EAN-13 leading 0 -> UPC-A
    return '';                                         // unsupported here
  }

  let activeEngine = null;
  let configured = false;
  let context, view, camera, barcodeCapture;

  async function ensureSDKLoadedAndConfigured(){
    if (!LICENSE) throw new Error('Missing SCANDIT_LICENSE');

    if (SDK() && configured) return;                   // ready
    if (SDK() && !configured && activeEngine) {
      await SDK().configure(LICENSE, { engineLocation: activeEngine });
      configured = true;
      return;
    }

    // Try each CDN until one succeeds
    let lastErr = null;
    for (const src of SOURCES) {
      try {
        if (!SDK()) await loadScript(src.js);
        if (!SDK()) throw new Error('Scandit global not found after ' + src.js);
        await SDK().configure(LICENSE, { engineLocation: src.engine });
        activeEngine = src.engine;
        configured = true;
        console.log('[Scanner] Scandit configured via', src.js);
        return;
      } catch (e) {
        console.warn('[Scanner] loader/configure failed:', e?.message || e);
        lastErr = e;
      }
    }
    throw lastErr || new Error('All Scandit sources failed');
  }

  // ---- UI helpers ----
  async function promptFallback(){
    const v = window.prompt('Enter 12-digit UPC');
    if (!isDigits12(v)) throw new Error('closed');
    return String(v).trim();
  }
  function buildModal() {
    const root = document.createElement('div');
    root.id = 'scanModal';
    root.className = 'card camera';
    root.innerHTML = `
      <div id="scanView" style="width:100%;height:65vh;border-radius:16px;overflow:hidden;"></div>
      <div class="actions" style="margin-top:.75rem;">
        <button class="btn ghost" id="closeScanBtn" type="button">Close Camera</button>
      </div>
    `;
    (document.querySelector('#screen') || document.body).prepend(root);
    return root;
  }

  // ---- scanner ----
  async function open() {
    try {
      await ensureSDKLoadedAndConfigured();
    } catch (e) {
      console.error('[Scanner] bundled script load/configure error:', e?.message || e);
      return promptFallback();
    }

    const S = SDK();
    return new Promise(async (resolve, reject) => {
      try {
        if (!context) {
          // Context + View
          context = await S.DataCaptureContext.create();
          view    = await S.DataCaptureView.create(context);

          // Built-in camera with recommended settings (per docs)
          camera  = S.Camera.default;
          const cameraSettings = S.BarcodeCapture.recommendedCameraSettings;
          await camera.applySettings(cameraSettings);
          await context.setFrameSource(camera);

          // Capture settings: enable exactly the retail set
          const settings = new S.BarcodeCaptureSettings();
          settings.enableSymbologies([
            S.Symbology.ean13Upca,  // EAN-13 + UPC-A
            S.Symbology.ean8,       // registered; currently rejected in logic below
            S.Symbology.upce        // registered; currently rejected in logic below
          ]);
          settings.codeDuplicateFilter = 1000; // ms: ignore duplicates briefly
          barcodeCapture = await S.BarcodeCapture.create(context, settings);

          // Overlay / viewfinder
          const overlay = S.BarcodeCaptureOverlay.withBarcodeCaptureForView(barcodeCapture, view);
          overlay.viewfinder = new S.RectangularViewfinder();
        }

        // Modal host + attach view
        const modal = buildModal();
        const mount = modal.querySelector('#scanView');
        await view.connectToElement(mount);

        // Listener with rejection logic (per docs: reject in listener so it never hits session updates)
        const listener = {
          didScan: async (_, session) => {
            const barcodes = session.newlyRecognizedBarcodes || [];
            if (!barcodes.length) return;

            for (const b of barcodes) {
              const sym = b.symbology;
              const data = (b.data || '').trim();
              let accept = false;
              let normalized = '';

              if (sym === S.Symbology.ean13Upca) {
                normalized = normalizeToUpcA(data);
                accept = !!normalized; // UPC-A or EAN-13 starting 0
              } else if (sym === S.Symbology.ean8 || sym === S.Symbology.upce) {
                // Registered but currently not accepted until we implement expansion
                accept = false;
              }

              if (!accept) {
                if (typeof session.rejectCode === 'function') {
                  session.rejectCode(b);
                } else if (typeof session.rejectBarcode === 'function') {
                  session.rejectBarcode(b);
                }
                continue; // evaluate any other codes this frame
              }

              // Accept: stop scanning and resolve with normalized UPC-A (12 digits)
              try { await barcodeCapture.setEnabled(false); } catch(e){}
              try { await camera.switchToDesiredState(S.FrameSourceState.Off); } catch(e){}
              close();
              return resolve(normalized);
            }
            // Nothing accepted in this frame → keep scanning
          }
        };
        await barcodeCapture.addListener(listener);

        // Turn camera ON and enable capture
        await camera.switchToDesiredState(S.FrameSourceState.On);
        await barcodeCapture.setEnabled(true);

        modal.querySelector('#closeScanBtn').onclick = () => {
          close();
          reject(new Error('closed'));
        };
      } catch (err) {
        console.error('[Scanner] init error:', err);
        try { close(); } catch(e){}
        try { resolve(await promptFallback()); } catch(e){ reject(err); }
      }
    });
  }

  function close() {
    const S = SDK();
    try { barcodeCapture && barcodeCapture.setEnabled(false); } catch(e){}
    try { camera && S && camera.switchToDesiredState(S.FrameSourceState.Off); } catch(e){}
    const modal = document.getElementById('scanModal');
    if (modal) modal.remove();
  }

  // Pre-configure EARLY (per docs) so engine files are fetched before user clicks scan
  document.addEventListener('DOMContentLoaded', async () => {
    try { await ensureSDKLoadedAndConfigured(); }
    catch (e) { console.warn('[Scanner] early configure failed:', e?.message || e); }
  });

  window.Scanner = { open, close };
})();
</script>