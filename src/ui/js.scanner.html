<script>
/**
 * Scandit scanner (bundled) with resilient, self-booting loader.
 * - Logs environment on load.
 * - Immediately ensures Scandit global and configure() without relying on DOM events.
 * - Load order: inline/global -> same-origin (?static=scandit-index) -> CDN.
 * - Disables AMD/CommonJS temporarily so the SDK attaches to window.
 * - Built-in camera, recommended settings, retail symbologies, reject unwanted codes.
 * - Exposes window.Scanner.open() / close().
 */
(function () {
  // ----- Config -----
  const LICENSE = `<?= PropertiesService.getScriptProperties().getProperty('SCANDIT_LICENSE') || '' ?>`;
  const ENGINE_URL = 'https://cdn.jsdelivr.net/npm/scandit-web-datacapture-bundled@7.6.1/build/engine/';
  const CDN_BUNDLE  = 'https://cdn.jsdelivr.net/npm/scandit-web-datacapture-bundled@7.6.1/build/js/index.min.js';
  const ORIGIN_BUNDLE = (window.APP_BASE ? `${window.APP_BASE}?static=scandit-index` : null);

  // ----- Basic helpers -----
  const S = () => window.Scandit || null;
  const isDigits12 = v => /^\d{12}$/.test(String(v || ''));
  const normalizeToUpcA = s => {
    const v = String(s || '').trim();
    if (/^\d{12}$/.test(v)) return v;           // UPC-A
    if (/^0\d{12}$/.test(v)) return v.slice(1); // EAN-13 leading 0 -> UPC-A
    return '';
  };

  // ----- Logging on load -----
  console.log('[Scanner] boot', {
    hasScandit: !!S(),
    APP_BASE: window.APP_BASE || '(undefined)',
    ORIGIN_BUNDLE,
    CDN_BUNDLE,
    hasLicense: !!String(LICENSE).trim()
  });

  // Load a script ensuring it exports to window (disable AMD/CommonJS temporarily)
  function loadScriptForceGlobal(src) {
    return new Promise((resolve, reject) => {
      const prevDefine  = window.define;
      const prevModule  = window.module;
      const prevExports = window.exports;
      const hadAMD = !!(prevDefine && prevDefine.amd);

      try {
        if (hadAMD)      { try { delete window.define;  } catch(_) { window.define  = undefined; } }
        if (prevModule)  { try { delete window.module;  } catch(_) { window.module  = undefined; } }
        if (prevExports) { try { delete window.exports; } catch(_) { window.exports = undefined; } }
      } catch (_) {}

      const s = document.createElement('script');
      s.src = src;
      s.async = true;
      s.onload = () => {
        if (hadAMD) window.define = prevDefine;
        if (prevModule) window.module = prevModule;
        if (prevExports) window.exports = prevExports;
        resolve();
      };
      s.onerror = () => {
        if (hadAMD) window.define = prevDefine;
        if (prevModule) window.module = prevModule;
        if (prevExports) window.exports = prevExports;
        reject(new Error(`Failed to load ${src}`));
      };
      document.head.appendChild(s);
    });
  }

  async function ensureScandit() {
    if (S()) return true;

    const sources = [ORIGIN_BUNDLE, CDN_BUNDLE].filter(Boolean);
    for (const src of sources) {
      try {
        console.warn('[Scanner] Scandit missing; loading:', src);
        await loadScriptForceGlobal(src);
        console.log('[Scanner] bundle loaded; Scandit present?', !!S());
        if (S()) return true;
      } catch (e) {
        console.warn('[Scanner] load failed:', e.message || e);
      }
    }
    return !!S();
  }

  async function configureIfNeeded() {
    try {
      if (!(await ensureScandit())) throw new Error('Scandit global missing after loads');
      if (!String(LICENSE).trim()) throw new Error('Missing SCANDIT_LICENSE');
      await S().configure(LICENSE, { engineLocation: ENGINE_URL });
      console.log('[Scanner] configured OK');
      return true;
    } catch (e) {
      console.warn('[Scanner] configure failed:', e?.message || e);
      return false;
    }
  }

  // ----- Self-boot: ensure + configure right away (no DOM event dependency) -----
  (async () => { await configureIfNeeded(); })();

  // ----- UI helpers -----
  async function promptFallback() {
    const v = window.prompt('Enter 12-digit UPC');
    if (!isDigits12(v)) throw new Error('closed');
    return String(v).trim();
  }
  function buildModal() {
    const el = document.createElement('div');
    el.id = 'scanModal';
    el.className = 'card camera';
    el.innerHTML = `
      <div id="scanView" style="width:100%;height:65vh;border-radius:16px;overflow:hidden;"></div>
      <div class="actions" style="margin-top:.75rem;">
        <button class="btn ghost" id="closeScanBtn" type="button">Close Camera</button>
      </div>`;
    (document.querySelector('#screen') || document.body).prepend(el);
    return el;
  }

  // ----- Scanner state -----
  let context, view, camera, barcodeCapture;

  async function open() {
    try {
      // If for any reason weâ€™re not configured yet, do it now.
      await configureIfNeeded();

      return new Promise(async (resolve, reject) => {
        try {
          // One-time init
          if (!context) {
            context = await S().DataCaptureContext.create();
            view    = await S().DataCaptureView.create(context);
            camera  = S().Camera.default;

            const cs = S().BarcodeCapture.recommendedCameraSettings;
            await camera.applySettings(cs);
            await context.setFrameSource(camera);

            const settings = new S().BarcodeCaptureSettings();
            settings.enableSymbologies([
              S().Symbology.ean13Upca,
              S().Symbology.ean8,
              S().Symbology.upce
            ]);
            settings.codeDuplicateFilter = 1000;
            barcodeCapture = await S().BarcodeCapture.create(context, settings);

            const overlay = S().BarcodeCaptureOverlay.withBarcodeCaptureForView(barcodeCapture, view);
            overlay.viewfinder = new S().RectangularViewfinder();
          }

          const modal = buildModal();
          const mount = modal.querySelector('#scanView');
          await view.connectToElement(mount);

          const listener = {
            didScan: async (_, session) => {
              const list = session.newlyRecognizedBarcodes || [];
              if (!list.length) return;

              for (const b of list) {
                const sym  = b.symbology;
                const data = (b.data || '').trim();

                let accept = false;
                let normalized = '';

                if (sym === S().Symbology.ean13Upca) {
                  normalized = normalizeToUpcA(data);
                  accept = !!normalized;
                } else if (sym === S().Symbology.ean8 || sym === S().Symbology.upce) {
                  accept = false; // reject until we implement expansion
                }

                if (!accept) {
                  if (typeof session.rejectCode === 'function') session.rejectCode(b);
                  else if (typeof session.rejectBarcode === 'function') session.rejectBarcode(b);
                  continue;
                }

                try { await barcodeCapture.setEnabled(false); } catch (_) {}
                try { await camera.switchToDesiredState(S().FrameSourceState.Off); } catch (_) {}
                close();
                return resolve(normalized);
              }
            }
          };
          await barcodeCapture.addListener(listener);

          await camera.switchToDesiredState(S().FrameSourceState.On);
          await barcodeCapture.setEnabled(true);

          modal.querySelector('#closeScanBtn').onclick = () => {
            close();
            reject(new Error('closed'));
          };
        } catch (err) {
          console.error('[Scanner] init error:', err);
          try { close(); } catch (_) {}
          try { resolve(await promptFallback()); } catch (_) { reject(err); }
        }
      });
    } catch (e) {
      console.error('[Scanner] bundle unavailable:', e?.message || e);
      return promptFallback();
    }
  }

  function close() {
    try { barcodeCapture && barcodeCapture.setEnabled(false); } catch (_) {}
    try { camera && S() && camera.switchToDesiredState(S().FrameSourceState.Off); } catch (_) {}
    const modal = document.getElementById('scanModal');
    if (modal) modal.remove();
  }

  window.Scanner = { open, close };
})();
</script>