<script>
/**
 * Scandit Web (bundled) loader + scanner â€” SAME-ORIGIN
 * - Loads JS from:     ./?static=scandit-index
 * - Loads engine from: ./?static=engine/...
 * - Early configure(), built-in camera w/ recommended settings
 * - Retail symbologies registered; reject unwanted in listener
 * - Exposes window.Scanner.open() / close()
 */
(function () {
  const LICENSE = `<?= PropertiesService.getScriptProperties().getProperty('SCANDIT_LICENSE') || '' ?>`;

  const INDEX_URL = (window.APP_BASE || '.') + '?static=scandit-index';
  const ENGINE_URL = 'https://cdn.jsdelivr.net/npm/scandit-web-datacapture-bundled@7.6.1/build/engine/';
  // then await SDK().configure(LICENSE, { engineLocation: ENGINE_URL })

  // ---------- small helpers ----------
  function SDK(){ return window.Scandit || null; }
  function isDigits12(v){ return /^\d{12}$/.test(String(v||'')); }
  function normalizeToUpcA(s) {
    const v = String(s||'').trim();
    if (/^\d{12}$/.test(v)) return v;          // UPC-A direct
    if (/^0\d{12}$/.test(v)) return v.slice(1);// EAN-13 w/ leading 0 -> UPC-A
    return '';
  }
  function log(){ try{ console.log('[Scanner]', ...arguments); }catch(e){} }
  function warn(){ try{ console.warn('[Scanner]', ...arguments); }catch(e){} }
  function error(){ try{ console.error('[Scanner]', ...arguments); }catch(e){} }

  console.log('[Scanner] about to load', INDEX_URL, 'define?', typeof window.define, 'module?', typeof window.module);
  function loadScriptSameOrigin(src){
    return new Promise((resolve, reject) => {
      // Temporarily neutralize AMD/CommonJS so the UMD writes window.Scandit
      const prevDefine  = window.define;
      const prevModule  = window.module;
      const prevExports = window.exports;
      const hadDefineAmd = prevDefine && prevDefine.amd;

      try {
        if (hadDefineAmd) { try { delete window.define; } catch(_) { window.define = undefined; } }
        if (prevModule)   { try { delete window.module; } catch(_) { window.module = undefined; } }
        if (prevExports)  { try { delete window.exports; } catch(_) { window.exports = undefined; } }
      } catch (_) {}

      const s = document.createElement('script');
      s.src = src;
      s.async = true;

      s.onload = () => {
        // Restore environment
        if (hadDefineAmd) window.define = prevDefine;
        if (prevModule)   window.module = prevModule;
        if (prevExports)  window.exports = prevExports;

        // Sanity log
        console.log('[Scanner] script loaded, Scandit present?', !!window.Scandit);
        if (!window.Scandit) {
          reject(new Error('Scandit global missing after load'));
        } else {
          resolve();
        }
      };

      s.onerror = () => {
        if (hadDefineAmd) window.define = prevDefine;
        if (prevModule)   window.module = prevModule;
        if (prevExports)  window.exports = prevExports;
        reject(new Error('Failed to load: ' + src));
      };

      document.head.appendChild(s);
    });
  }

  async function ensureConfigured(){
    if (!LICENSE) throw new Error('Missing SCANDIT_LICENSE');
    if (SDK() && ensureConfigured._done) return;

    if (!SDK()) {
      log('loading bundled SDK from same origin:', INDEX_URL);
      await loadScriptSameOrigin(INDEX_URL);
      if (!SDK()) throw new Error('Scandit global missing after load');
    }

    log('calling configure()', { engine: ENGINE_URL });
    await SDK().configure(LICENSE, { engineLocation: ENGINE_URL });
    ensureConfigured._done = true;
    log('configured OK');
  }

  // ---------- UI helpers ----------
  async function promptFallback(){
    const v = window.prompt('Enter 12-digit UPC');
    if (!isDigits12(v)) throw new Error('closed');
    return String(v).trim();
  }
  function buildModal() {
    const root = document.createElement('div');
    root.id = 'scanModal';
    root.className = 'card camera';
    root.innerHTML = `
      <div id="scanView" style="width:100%;height:65vh;border-radius:16px;overflow:hidden;"></div>
      <div class="actions" style="margin-top:.75rem;">
        <button class="btn ghost" id="closeScanBtn" type="button">Close Camera</button>
      </div>
    `;
    (document.querySelector('#screen') || document.body).prepend(root);
    return root;
  }

  // ---------- scanner state ----------
  let context, view, camera, barcodeCapture;

  async function open() {
    try {
      await ensureConfigured();
    } catch (e) {
      error('bundled script load/configure error:', e?.message || e);
      return promptFallback();
    }

    const S = SDK();
    return new Promise(async (resolve, reject) => {
      try {
        if (!context) {
          // Context & View
          context = await S.DataCaptureContext.create();
          view    = await S.DataCaptureView.create(context);

          // Built-in camera with recommended settings (per docs)
          camera  = S.Camera.default;
          const cameraSettings = S.BarcodeCapture.recommendedCameraSettings;
          await camera.applySettings(cameraSettings);
          await context.setFrameSource(camera);

          // Capture settings: register retail set only
          const settings = new S.BarcodeCaptureSettings();
          settings.enableSymbologies([
            S.Symbology.ean13Upca,  // EAN-13 + UPC-A
            S.Symbology.ean8,       // registered; currently rejected
            S.Symbology.upce        // registered; currently rejected
          ]);
          settings.codeDuplicateFilter = 1000; // ms
          barcodeCapture = await S.BarcodeCapture.create(context, settings);

          // Overlay & Viewfinder
          const overlay = S.BarcodeCaptureOverlay.withBarcodeCaptureForView(barcodeCapture, view);
          overlay.viewfinder = new S.RectangularViewfinder();
        }

        // Attach to modal
        const modal = buildModal();
        const mount = modal.querySelector('#scanView');
        await view.connectToElement(mount);

        // Listener with REJECTION logic (keeps unwanted codes out of session)
        const listener = {
          didScan: async (_, session) => {
            const barcodes = session.newlyRecognizedBarcodes || [];
            if (!barcodes.length) return;

            for (const b of barcodes) {
              const sym = b.symbology;
              const data = (b.data || '').trim();
              let accept = false;
              let normalized = '';

              if (sym === S.Symbology.ean13Upca) {
                normalized = normalizeToUpcA(data);
                accept = !!normalized; // accept UPC-A or EAN-13 with leading 0
              } else if (sym === S.Symbology.ean8 || sym === S.Symbology.upce) {
                accept = false;        // TODO: add proper expansion when ready
              }

              if (!accept) {
                if (typeof session.rejectCode === 'function') session.rejectCode(b);
                else if (typeof session.rejectBarcode === 'function') session.rejectBarcode(b);
                log('rejected', { sym, data });
                continue;
              }

              log('accepted', { data, normalized });
              try { await barcodeCapture.setEnabled(false); } catch(e){}
              try { await camera.switchToDesiredState(S.FrameSourceState.Off); } catch(e){}
              close();
              return resolve(normalized);
            }
          }
        };
        await barcodeCapture.addListener(listener);

        // Turn camera ON & start capture
        await camera.switchToDesiredState(S.FrameSourceState.On);
        await barcodeCapture.setEnabled(true);
        log('camera on & capture enabled');

        modal.querySelector('#closeScanBtn').onclick = () => {
          close();
          reject(new Error('closed'));
        };
      } catch (err) {
        error('init error:', err);
        try { close(); } catch(e){}
        try { resolve(await promptFallback()); } catch(e){ reject(err); }
      }
    });
  }

  function close() {
    const S = SDK();
    try { barcodeCapture && barcodeCapture.setEnabled(false); } catch(e){}
    try { camera && S && camera.switchToDesiredState(S.FrameSourceState.Off); } catch(e){}
    const modal = document.getElementById('scanModal');
    if (modal) modal.remove();
    log('scanner closed');
  }

  // Configure EARLY so engine files preload
  document.addEventListener('DOMContentLoaded', async () => {
    try { await ensureConfigured(); }
    catch (e) { warn('early configure failed:', e?.message || e); }
  });

  window.Scanner = { open, close };
})();
</script>