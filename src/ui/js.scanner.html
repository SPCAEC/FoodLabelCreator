<script>
/**
 * Scandit 7.6.1 setup (Web SDK).
 * Exposes global: window.Scanner.open() -> Promise<string>, window.Scanner.close()
 *
 * - Configures core & barcode packages with license + engineLocation.
 * - Shows a modal with live camera view.
 * - Resolves with first scanned EAN13/UPCA code, then closes.
 */

(function(){
  const LICENSE = `<?= PropertiesService.getScriptProperties().getProperty('SCANDIT_LICENSE') || '' ?>`;
  const ENGINE_LOCATION = "https://cdn.jsdelivr.net/npm/@scandit/web-datacapture-core@7.6.1/build/engine/";

  let context, view, camera, barcodeCapture;

  async function initScandit() {
    if (!window.ScanditSDK) throw new Error('Scandit SDK not loaded');
    // Configure SDK once
    await ScanditSDK.configure(LICENSE, { engineLocation: ENGINE_LOCATION });
    if (!context) {
      context = await ScanditSDK.DataCaptureContext.create();
      view = await ScanditSDK.DataCaptureView.create(context);
      camera = ScanditSDK.Camera.default;
      await context.setFrameSource(camera);

      // Barcode settings
      const settings = new ScanditSDK.BarcodeCaptureSettings();
      settings.enableSymbologies([ScanditSDK.Symbology.ean13Upca]);
      barcodeCapture = await ScanditSDK.BarcodeCapture.create(context, settings);

      // Overlay for aiming UI
      const overlay = ScanditSDK.BarcodeCaptureOverlay.withBarcodeCaptureForView(barcodeCapture, view);
      overlay.viewfinder = new ScanditSDK.RectangularViewfinder();
    }
    return { context, view, camera, barcodeCapture };
  }

  async function open(){
    return new Promise(async (resolve, reject) => {
      try{
        const { view, camera, barcodeCapture } = await initScandit();

        // Create modal
        const root = document.createElement('div');
        root.id = 'scanModal';
        root.className = 'card camera';
        root.innerHTML = `
          <div id="scanView" style="width:100%;height:65vh;border-radius:16px;overflow:hidden;"></div>
          <div class="actions" style="margin-top:.75rem;">
            <button class="btn ghost" id="closeScanBtn">Close Camera</button>
          </div>
        `;
        document.querySelector('#screen').prepend(root);

        // Attach view
        await view.connectToElement(document.getElementById('scanView'));

        // Listener
        const listener = {
          didScan: async (_, session) => {
            const newly = session.newlyRecognizedBarcodes;
            if (newly.length) {
              const code = newly[0].data;
              await barcodeCapture.setEnabled(false);
              await camera.switchToDesiredState(ScanditSDK.FrameSourceState.Off);
              close();
              resolve(code);
            }
          }
        };
        await barcodeCapture.addListener(listener);

        // Start camera
        await camera.switchToDesiredState(ScanditSDK.FrameSourceState.On);
        await barcodeCapture.setEnabled(true);

        // Close button
        document.getElementById('closeScanBtn').onclick = () => {
          close();
          reject(new Error('closed'));
        };

      }catch(err){
        reject(err);
      }
    });
  }

  function close(){
    if (barcodeCapture) barcodeCapture.setEnabled(false).catch(()=>{});
    if (camera) camera.switchToDesiredState(ScanditSDK.FrameSourceState.Off).catch(()=>{});
    const modal = document.getElementById('scanModal');
    if (modal) modal.remove();
  }

  window.Scanner = { open, close };
})();
</script>