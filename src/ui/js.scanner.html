<script>
/** Scandit 7.6.1 setup (Web SDK). Uses your license + shows a modal-like preview.
 * Notes:
 * - We configure core & barcode packages and create a DataCaptureView attached to #scanView.
 * - On first valid scan (EAN-13), we stop the camera and resolve with the code.
 * - Close Camera button stops and hides the view.
 *
 * See Scandit docs: configure core, create context/view/camera, add BarcodeCapture mode & listener. 
 */
const ScanditConfig = {
  licenseKey: `<?= PropertiesService.getScriptProperties().getProperty('SCANDIT_LICENSE') || '' ?>`,
  // Engine files location (served by jsDelivr CDN)
  libraryLocation: "https://cdn.jsdelivr.net/npm/@scandit/web-datacapture-core@7.6.1/build/engine/",
};

let scandit = null;

async function initScanditOnce(){
  if (scandit) return scandit;
  const { Scandit } = window;
  // Configure core with engine location & license
  await Scandit.DataCaptureContext.configure({
    licenseKey: ScanditConfig.licenseKey,
  }, { libraryLocation: ScanditConfig.libraryLocation });

  const context = await Scandit.DataCaptureContext.create();
  const view = await Scandit.DataCaptureView.create(context);
  const camera = Scandit.Camera.default;
  await context.setFrameSource(camera);

  // Barcode capture settings: enable EAN13/UPCA (12-digit UPC)
  const settings = new Scandit.BarcodeCaptureSettings();
  settings.enableSymbologies([Scandit.BarcodeSymbology.Ean13Upca]);

  const barcodeCapture = await Scandit.BarcodeCapture.create(context, settings);

  // Overlay for aiming UI
  const overlay = await Scandit.BarcodeCaptureOverlay.withBarcodeCaptureForView(barcodeCapture, view);
  overlay.viewfinder = new Scandit.RectangularViewfinder();

  // Listener: on scan, stop and return the data
  const listeners = {
    didScan: async (_, session) => {
      const newly = session.newlyRecognizedBarcodes;
      if (newly.length) {
        const code = newly[0].data;
        // Stop capture & camera
        await barcodeCapture.setEnabled(false);
        await camera.switchToDesiredState(Scandit.FrameSourceState.Off);
        hideScanner();
        if (typeof window._onScanned === 'function') window._onScanned(code);
      }
    }
  };
  await barcodeCapture.addListener(listeners);

  scandit = { Scandit, context, view, camera, barcodeCapture };
  return scandit;
}

async function showScanner(){
  const root = document.createElement('div');
  root.id = 'scanModal';
  root.className = 'card camera';
  root.innerHTML = `
    <div id="scanView" style="width:100%;height:65vh;border-radius:16px;overflow:hidden;"></div>
    <div class="actions" style="margin-top:.75rem;">
      <button class="btn ghost" id="closeScanBtn">Close Camera</button>
    </div>
  `;
  document.querySelector('#screen').prepend(root);

  const s = await initScanditOnce();
  document.getElementById('closeScanBtn').onclick = hideScanner;
  await s.view.connectToElement(document.getElementById('scanView'));

  await s.camera.switchToDesiredState(s.Scandit.FrameSourceState.On);
  await s.barcodeCapture.setEnabled(true);
}

async function hideScanner(){
  if (!scandit) return;
  await scandit.barcodeCapture.setEnabled(false);
  await scandit.camera.switchToDesiredState(scandit.Scandit.FrameSourceState.Off);
  const modal = document.getElementById('scanModal');
  if (modal) modal.remove();
}
</script>