<script>
/**
 * Scandit 7.6.1 (bundled) camera scanner
 * Exposes: window.Scanner.open() -> Promise<string>, window.Scanner.close()
 */
(function () {
  const LICENSE = `<?= PropertiesService.getScriptProperties().getProperty('SCANDIT_LICENSE') || '' ?>`;

  // Bundled build (Core + Barcode in one file)
  const BUNDLED_JS = "https://cdn.jsdelivr.net/npm/scandit-web-datacapture-bundled@7.6.1/build/js/index.min.js";
  const ENGINE     = "https://cdn.jsdelivr.net/npm/scandit-web-datacapture-bundled@7.6.1/build/engine/";

  function SDK() { return window.Scandit || null; }

  function isValidUPC(v){ return /^\d{12}$/.test(String(v||'').trim()); }
  async function promptFallback(){
    const v = window.prompt('Enter 12-digit UPC');
    if (!isValidUPC(v)) throw new Error('closed');
    return String(v).trim();
  }

  function loadScript(src){
    return new Promise((resolve, reject) => {
      const el = document.createElement('script');
      el.src = src;
      el.async = true;
      el.onload  = () => resolve(src);
      el.onerror = () => reject(new Error('Failed to load: ' + src));
      document.head.appendChild(el);
    });
  }

  async function ensureSDK(){
    if (SDK()) return;
    await loadScript(BUNDLED_JS);
    if (!SDK()) throw new Error('Scandit global not found after loading bundled script');
  }

  let context, view, camera, barcodeCapture;

  async function initScandit() {
    const S = SDK();
    if (!S) throw new Error('Scandit SDK not loaded');

    if (!context) {
      await S.configure(LICENSE, { engineLocation: ENGINE });

      context = await S.DataCaptureContext.create();
      view    = await S.DataCaptureView.create(context);

      camera  = S.Camera.default;
      await context.setFrameSource(camera);

      const settings = new S.BarcodeCaptureSettings();
      settings.enableSymbologies([S.Symbology.ean13Upca]);

      barcodeCapture = await S.BarcodeCapture.create(context, settings);
      const overlay = S.BarcodeCaptureOverlay.withBarcodeCaptureForView(barcodeCapture, view);
      overlay.viewfinder = new S.RectangularViewfinder();
    }
    return { S, context, view, camera, barcodeCapture };
  }

  function buildModal() {
    const root = document.createElement('div');
    root.id = 'scanModal';
    root.className = 'card camera';
    root.innerHTML = `
      <div id="scanView" style="width:100%;height:65vh;border-radius:16px;overflow:hidden;"></div>
      <div class="actions" style="margin-top:.75rem;">
        <button class="btn ghost" id="closeScanBtn" type="button">Close Camera</button>
      </div>
    `;
    (document.querySelector('#screen') || document.body).prepend(root);
    return root;
  }

  async function open() {
    if (!LICENSE) {
      console.warn('[Scanner] Missing SCANDIT_LICENSE; using prompt fallback');
      return promptFallback();
    }

    try { await ensureSDK(); }
    catch (e) {
      console.error('[Scanner] Bundled script load error:', e?.message || e);
      return promptFallback();
    }

    return new Promise(async (resolve, reject) => {
      try {
        const { S } = await initScandit();

        const modal = buildModal();
        const mount = modal.querySelector('#scanView');
        await view.connectToElement(mount);

        const listener = {
          didScan: async (_, session) => {
            const newly = session.newlyRecognizedBarcodes;
            if (newly.length) {
              const code = newly[0].data;
              try { await barcodeCapture.setEnabled(false); } catch(e){}
              try { await camera.switchToDesiredState(S.FrameSourceState.Off); } catch(e){}
              close();
              resolve(code);
            }
          }
        };
        await barcodeCapture.addListener(listener);

        await camera.switchToDesiredState(S.FrameSourceState.On);
        await barcodeCapture.setEnabled(true);

        modal.querySelector('#closeScanBtn').onclick = () => {
          close();
          reject(new Error('closed'));
        };
      } catch (err) {
        console.error('[Scanner] init error:', err);
        try { close(); } catch(e){}
        try { resolve(await promptFallback()); } catch(e){ reject(err); }
      }
    });
  }

  function close() {
    const S = SDK();
    try { barcodeCapture && barcodeCapture.setEnabled(false); } catch(e){}
    try { camera && S && camera.switchToDesiredState(S.FrameSourceState.Off); } catch(e){}
    const modal = document.getElementById('scanModal');
    if (modal) modal.remove();
  }

  window.Scanner = { open, close };
})();
</script>