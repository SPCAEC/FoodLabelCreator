<script>
/**
 * Scandit 7.6.1 camera scanner
 * Exposes: window.Scanner.open() -> Promise<string>, window.Scanner.close()
 */
(function () {
  const LICENSE = `<?= PropertiesService.getScriptProperties().getProperty('SCANDIT_LICENSE') || '' ?>`;
  const ENGINE_LOCATION = "https://cdn.jsdelivr.net/npm/scandit-web-datacapture-core@7.6.1/build/engine/";

  // Accept any of the possible globals the CDN may define
  const SDK = window.ScanditSDK || window.Scandit || window.scandit;

  // Fallback prompt (keeps app usable if SDK missing)
  function isValidUPC(v){ return /^\d{12}$/.test(String(v||'').trim()); }
  async function promptFallback(){
    const v = window.prompt('Enter 12-digit UPC');
    if (!isValidUPC(v)) throw new Error('closed');
    return String(v).trim();
  }

  let context, view, camera, barcodeCapture;

  async function initScandit() {
    if (!SDK) throw new Error('Scandit SDK not loaded');
    // Configure once
    if (!context) {
      await SDK.configure(LICENSE, { engineLocation: ENGINE_LOCATION });

      context = await SDK.DataCaptureContext.create();
      view    = await SDK.DataCaptureView.create(context);

      camera  = SDK.Camera.default;
      await context.setFrameSource(camera);

      const settings = new SDK.BarcodeCaptureSettings();
      settings.enableSymbologies([SDK.Symbology.ean13Upca]);

      barcodeCapture = await SDK.BarcodeCapture.create(context, settings);

      const overlay = SDK.BarcodeCaptureOverlay.withBarcodeCaptureForView(barcodeCapture, view);
      overlay.viewfinder = new SDK.RectangularViewfinder();
    }
    return { context, view, camera, barcodeCapture };
  }

  function buildModal() {
    const root = document.createElement('div');
    root.id = 'scanModal';
    root.className = 'card camera';
    root.innerHTML = `
      <div id="scanView" style="width:100%;height:65vh;border-radius:16px;overflow:hidden;"></div>
      <div class="actions" style="margin-top:.75rem;">
        <button class="btn ghost" id="closeScanBtn" type="button">Close Camera</button>
      </div>
    `;
    (document.querySelector('#screen') || document.body).prepend(root);
    return root;
  }

  async function open() {
    // If SDK isnâ€™t present or license missing, gracefully fallback to prompt
    if (!SDK || !LICENSE) return promptFallback();

    return new Promise(async (resolve, reject) => {
      try {
        const { view, camera, barcodeCapture } = await initScandit();
        const modal = buildModal();
        const mount = modal.querySelector('#scanView');

        await view.connectToElement(mount);

        const listener = {
          didScan: async (_, session) => {
            const newly = session.newlyRecognizedBarcodes;
            if (newly.length) {
              const code = newly[0].data;
              await barcodeCapture.setEnabled(false);
              await camera.switchToDesiredState(SDK.FrameSourceState.Off);
              close();
              resolve(code);
            }
          }
        };
        await barcodeCapture.addListener(listener);

        await camera.switchToDesiredState(SDK.FrameSourceState.On);
        await barcodeCapture.setEnabled(true);

        modal.querySelector('#closeScanBtn').onclick = () => {
          close();
          reject(new Error('closed'));
        };
      } catch (err) {
        // If anything inits wrong, fallback to prompt so the user can still proceed
        console.error('Scanner init error:', err);
        try { close(); } catch(e){}
        try { resolve(await promptFallback()); } catch(e){ reject(err); }
      }
    });
  }

  function close() {
    try { barcodeCapture && barcodeCapture.setEnabled(false); } catch(e){}
    try { camera && camera.switchToDesiredState((SDK && SDK.FrameSourceState.Off) || 'off'); } catch(e){}
    const modal = document.getElementById('scanModal');
    if (modal) modal.remove();
  }

  window.Scanner = { open, close };
})();
</script>