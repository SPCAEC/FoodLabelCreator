<script>
/**
 * Scandit 7.6.1 camera scanner with dynamic loader
 * Exposes: window.Scanner.open() -> Promise<string>, window.Scanner.close()
 */
(function () {
  const LICENSE = `<?= PropertiesService.getScriptProperties().getProperty('SCANDIT_LICENSE') || '' ?>`;

  // Correct CDN bundle + engine paths (unscoped packages)
  const CORE_JS   = "https://cdn.jsdelivr.net/npm/scandit-web-datacapture-core@7.6.1/build/js/bundles/scandit-datacapture-core.min.js";
  const BARCODE_JS= "https://cdn.jsdelivr.net/npm/scandit-web-datacapture-barcode@7.6.1/build/js/bundles/scandit-datacapture-barcode.min.js";
  const ENGINE    = "https://cdn.jsdelivr.net/npm/scandit-web-datacapture-core@7.6.1/build/engine/";

  function getSDK() {
    return window.ScanditSDK || window.Scandit || window.scandit || null;
  }

  function isValidUPC(v){ return /^\d{12}$/.test(String(v||'').trim()); }
  async function promptFallback(){
    const v = window.prompt('Enter 12-digit UPC');
    if (!isValidUPC(v)) throw new Error('closed');
    return String(v).trim();
  }

  function loadScript(src){
    return new Promise((resolve, reject) => {
      const el = document.createElement('script');
      el.src = src;
      el.async = true;
      el.onload  = () => resolve(src);
      el.onerror = () => reject(new Error('Failed to load: ' + src));
      document.head.appendChild(el);
    });
  }

  async function ensureSDKLoaded(){
    // If already present, done
    if (getSDK()) return;

    // Try loading Core then Barcode
    try {
      await loadScript(CORE_JS);
      await loadScript(BARCODE_JS);
    } catch (e) {
      console.error('[Scanner] SDK script load error:', e && e.message ? e.message : e);
      throw e;
    }

    if (!getSDK()) {
      throw new Error('Scandit SDK global not found after loading scripts');
    }
  }

  let context, view, camera, barcodeCapture;

  async function initScandit() {
    const SDK = getSDK();
    if (!SDK) throw new Error('Scandit SDK not loaded');

    if (!context) {
      await SDK.configure(LICENSE, { engineLocation: ENGINE });

      context = await SDK.DataCaptureContext.create();
      view    = await SDK.DataCaptureView.create(context);

      camera  = SDK.Camera.default;
      await context.setFrameSource(camera);

      const settings = new SDK.BarcodeCaptureSettings();
      settings.enableSymbologies([SDK.Symbology.ean13Upca]);

      barcodeCapture = await SDK.BarcodeCapture.create(context, settings);

      const overlay = SDK.BarcodeCaptureOverlay.withBarcodeCaptureForView(barcodeCapture, view);
      overlay.viewfinder = new SDK.RectangularViewfinder();
    }
    return { SDK, context, view, camera, barcodeCapture };
  }

  function buildModal() {
    const root = document.createElement('div');
    root.id = 'scanModal';
    root.className = 'card camera';
    root.innerHTML = `
      <div id="scanView" style="width:100%;height:65vh;border-radius:16px;overflow:hidden;"></div>
      <div class="actions" style="margin-top:.75rem;">
        <button class="btn ghost" id="closeScanBtn" type="button">Close Camera</button>
      </div>
    `;
    (document.querySelector('#screen') || document.body).prepend(root);
    return root;
  }

  async function open() {
    // No license? fall back to prompt
    if (!LICENSE) {
      console.warn('[Scanner] Missing SCANDIT_LICENSE, using prompt fallback');
      return promptFallback();
    }

    // Make sure the SDK is actually present (load it if not)
    try {
      await ensureSDKLoaded();
    } catch (e) {
      console.warn('[Scanner] SDK unavailable; using prompt fallback');
      return promptFallback();
    }

    return new Promise(async (resolve, reject) => {
      try {
        const { SDK } = await initScandit();

        const modal = buildModal();
        const mount = modal.querySelector('#scanView');

        await view.connectToElement(mount);

        const listener = {
          didScan: async (_, session) => {
            const newly = session.newlyRecognizedBarcodes;
            if (newly.length) {
              const code = newly[0].data;
              try { await barcodeCapture.setEnabled(false); } catch(e){}
              try { await camera.switchToDesiredState(SDK.FrameSourceState.Off); } catch(e){}
              close();
              resolve(code);
            }
          }
        };
        await barcodeCapture.addListener(listener);

        await camera.switchToDesiredState(SDK.FrameSourceState.On);
        await barcodeCapture.setEnabled(true);

        modal.querySelector('#closeScanBtn').onclick = () => {
          close();
          reject(new Error('closed'));
        };
      } catch (err) {
        console.error('[Scanner] init error:', err);
        try { close(); } catch(e){}
        // last-resort fallback so volunteers can still proceed
        try { resolve(await promptFallback()); }
        catch(e){ reject(err); }
      }
    });
  }

  function close() {
    const SDK = getSDK();
    try { barcodeCapture && barcodeCapture.setEnabled(false); } catch(e){}
    try { camera && SDK && camera.switchToDesiredState(SDK.FrameSourceState.Off); } catch(e){}
    const modal = document.getElementById('scanModal');
    if (modal) modal.remove();
  }

  window.Scanner = { open, close };
})();
</script>