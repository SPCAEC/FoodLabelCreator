<script>
/**
 * App controller for Food Label Creator (clean rewrite)
 * - Launch screen: scan or enter UPC
 * - New item flow: capture front + ingredients photos, run AI
 * - Result flow: review or edit metadata before generating label
 */
(function(){
  const $ = sel => document.querySelector(sel);
  const $$ = sel => [...document.querySelectorAll(sel)];

  const state = {
    upc: '',
    item: null,
    exp: '',
    photos: { front: null, ingredients: null },
    pdf: { url: '', id: '' },
    needs: { ingredients: false }
  };
  console.log('[INIT] state is', state);

  const isValidUPC = v => /^\d{12}$/.test(String(v || '').trim());
  const isValidDate = v => /^(0[1-9]|1[0-2])\/(0[1-9]|[12]\d|3[01])\/\d{4}$/.test(String(v || ''));

  function setMsg(el, text, type){
    if (!el) return;
    el.textContent = text || '';
    el.className = 'msg';
    if (type) el.classList.add(type);
  }

  function spinner(on, el){
    if (el) {
      el.toggleAttribute('hidden', !on);
      el.style.display = on ? 'inline-block' : 'none';
    }
  }

  function navigate(id){
    $$('.screen').forEach(s => s.classList.remove('active'));
    const el = document.getElementById(id);
    if (el) {
      el.classList.add('active');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  }

  function resetApp(){
    Object.assign(state, {
      upc: '',
      item: null,
      exp: '',
      photos: { front: null, ingredients: null },
      pdf: { url: '', id: '' },
      needs: { ingredients: false }
    });

    $('#upcInput').value = '';
    $('#lookupBtn').disabled = true;
    navigate('screenLaunch');
  }

  function wireGlobal(){
    $$('.startOver').forEach(btn => btn.addEventListener('click', resetApp));
  }

  function wireLaunch(){
    const input = $('#upcInput');
    const lookupBtn = $('#lookupBtn');
    const scanBtn = $('#scanBtn');
    const clearBtn = $('#clearBtn');
    const status = $('#launchInfo');
    const load = $('#launchLoad');

    function updateBtn(){
      lookupBtn.disabled = !isValidUPC(input.value);
    }

    input.addEventListener('input', () => {
      input.value = input.value.replace(/\D/g, '').slice(0, 12);
      updateBtn();
    });

    lookupBtn.addEventListener('click', async () => {
      if (lookupBtn.disabled) return;
      state.upc = input.value;
      await doLookup(status, load);
    });

    scanBtn.addEventListener('click', () => {
      setMsg(status, 'Opening scanner…');
      window.MiniScanner.open();
    });

    clearBtn?.addEventListener('click', () => {
      input.value = '';
      updateBtn();
      setMsg(status, '');
    });

    updateBtn();
    spinner(false, load);
  }

  async function doLookup(statusEl, loadEl){
    setMsg(statusEl, 'Looking up barcode…');
    spinner(true, loadEl);
    try {
      const res = await API.lookup(state.upc);
      if (res?.found) {
        state.item = normalizeItem(res.item);
        navigate('screenResults');
        setTimeout(renderResults, 0);
      } else {
        state.item = null;
        navigate('screenNew');
      }
      setMsg(statusEl, '');
    } catch (err) {
      console.error('[lookup error]', err);
      setMsg(statusEl, 'Lookup failed.', 'error');
    } finally {
      spinner(false, loadEl);
    }
  }

  window.addEventListener('upc-scanned', async ev => {
    const upc = ev.detail?.upc || '';
    $('#upcInput').value = upc;
    $('#lookupBtn').disabled = !isValidUPC(upc);
    setMsg($('#launchInfo'), 'Scanned ✓ Looking up…', 'success');
    spinner(true, $('#launchLoad'));
    try {
      state.upc = upc;
      await doLookup($('#launchInfo'), $('#launchLoad'));
    } catch (e) {
      setMsg($('#launchInfo'), 'Scan failed.', 'error');
    }
    spinner(false, $('#launchLoad'));
  });

  window.addEventListener('upc-scan-canceled', () => {
    setMsg($('#launchInfo'), 'Scanner closed.');
  });

  function normalizeItem(item){
    return {
      upc: String(item.upc || ''),
      brand: String(item.brand || ''),
      productName: String(item.productName || ''),
      flavor: String(item.flavor || ''),
      species: String(item.species || ''),
      lifestage: String(item.lifestage || ''),
      ingredients: String(item.ingredients || '')
    };
  }

  function renderReview(){
    const i = state.item || {};
    $('#revExp').value = state.exp || '';
    $('#revSpecies').value = i.species || 'Dog';
    $('#revStage').value = i.lifestage || 'Adult';
    $('#revBrand').value = i.brand || '';
    $('#revName').value = i.productName || '';
    $('#revFlavor').value = i.flavor || '';
    $('#revIngredients').value = i.ingredients || '';
    $('#revTreatFood').value = i.type || '';
  }

  function wireNewItem(){
    const msg = $('#newStatus');
    const spin = $('#newLoad');
    const next = $('#photoContinue');
    const actions = $('#photoActions');
    const ingBlock = $('#ingredientsBlock');

    $('#frontBtn')?.addEventListener('click', () => {
      captureImage(dataUrl => {
        state.photos.front = dataUrl;
        $('#frontPreview').src = dataUrl;
        $('#frontPreview').classList.remove('hidden');
        ingBlock?.classList.remove('hidden');
        checkReady();
      });
    });

    $('#ingredientsBtn')?.addEventListener('click', () => {
      captureImage(dataUrl => {
        state.photos.ingredients = dataUrl;
        $('#ingredientsPreview').src = dataUrl;
        $('#ingredientsPreview').classList.remove('hidden');
        checkReady();
      });
    });

    next?.addEventListener('click', async () => {
      const front = state.photos.front;
      const ing = state.photos.ingredients;
      console.log('[AI EXTRACT] Front:', front?.substring(0, 50));
      console.log('[AI EXTRACT] Ingredients:', ing?.substring(0, 50));

      if (!front || !ing || front.length < 100 || ing.length < 100) {
        setMsg(msg, 'Missing or invalid image(s).', 'error');
        return;
      }

      setMsg(msg, 'Extracting label data…', 'success');
      spinner(true, spin);

      try {
        const extracted = await API.extract(state.photos.front, state.photos.ingredients);

        console.log('[EXTRACT RESULT]', extracted);

        state.item = normalizeItem({ upc: state.upc, ...extracted });
        navigate('screenReview');
        setTimeout(renderReview, 0);
      } catch (err) {
        console.error('[extract error]', err);
        setMsg(msg, 'AI extraction failed.', 'error');
      } finally {
        spinner(false, spin);
      }
    });

    function checkReady(){
      if (state.photos.front && state.photos.ingredients) {
        actions?.classList.remove('hidden');
      }
    }
  }

  function captureImage(callback){
    const overlay = document.createElement('div');
    overlay.className = 'camera-overlay';
    overlay.innerHTML = `
      <video autoplay playsinline></video>
      <button class="btn take">Take Photo</button>
      <button class="btn secondary cancel">Cancel</button>
    `;
    document.body.appendChild(overlay);

    const video = overlay.querySelector('video');
    const take = overlay.querySelector('.take');
    const cancel = overlay.querySelector('.cancel');

    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }).then(stream => {
      video.srcObject = stream;

      take.onclick = () => {
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        const url = canvas.toDataURL('image/jpeg');
        stream.getTracks().forEach(track => track.stop());
        overlay.remove();
        callback(url);
      };

      cancel.onclick = () => {
        stream.getTracks().forEach(track => track.stop());
        overlay.remove();
      };
    }).catch(err => {
      console.error('[camera error]', err);
      setMsg($('#newStatus'), 'Camera not available', 'error');
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    wireGlobal();
    wireLaunch();
    wireNewItem();
    navigate('screenLaunch');
  });
})();
</script>