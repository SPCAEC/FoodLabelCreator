<script>
/**
 * App controller (rewritten cleanly)
 * - Launches scanner, looks up UPC
 * - Navigates user through label creation flow
 * - Works with backend API via google.script.run (API.*)
 */

(function(){
  const $ = sel => document.querySelector(sel);
  const $$ = sel => [...document.querySelectorAll(sel)];

  const state = {
    upc: '',
    item: null,
    exp: '',
    photos: { front: null, ingredients: null },
    pdf: { url: '', id: '' },
    needs: { ingredients: false }
  };

  const isValidUPC = v => /^\d{12}$/.test(String(v || '').trim());
  const isValidDate = v => /^(0[1-9]|1[0-2])\/(0[1-9]|[12]\d|3[01])\/\d{4}$/.test(String(v||''));

  function setMsg(el, text, type){
    if (!el) return;
    el.textContent = text || '';
    el.className = 'msg';
    if (type) el.classList.add(type);
  }

  function spinner(on, el){
    if (el) {
      el.toggleAttribute('hidden', !on);
      el.style.display = on ? 'inline-block' : 'none';
    }
  }

  function navigate(id){
    $$('.screen').forEach(s => s.classList.remove('active'));
    const el = document.getElementById(id);
    if (el) {
      el.classList.add('active');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  }

  function resetApp(){
    Object.assign(state, {
      upc: '',
      item: null,
      exp: '',
      photos: { front: null, ingredients: null },
      pdf: { url: '', id: '' },
      needs: { ingredients: false }
    });

    const upc = $('#upcInput');
    const lookupBtn = $('#lookupBtn');
    if (upc) upc.value = '';
    if (lookupBtn) lookupBtn.disabled = true;

    navigate('screenLaunch');
  }

  function wireGlobal(){
    $$('.startOver').forEach(b => b.addEventListener('click', resetApp));
  }

  function wireLaunch(){
    const upcInput = $('#upcInput');
    const lookupBtn = $('#lookupBtn');
    const scanBtn = $('#scanBtn');
    const clearBtn = $('#clearBtn');
    const status = $('#launchInfo');
    const load = $('#launchLoad');

    function updateLookupBtn(){
      lookupBtn.disabled = !isValidUPC(upcInput.value);
    }

    upcInput.addEventListener('input', () => {
      upcInput.value = upcInput.value.replace(/\D/g, '').slice(0, 12);
      updateLookupBtn();
    });

    lookupBtn.addEventListener('click', async () => {
      if (lookupBtn.disabled) return;
      state.upc = upcInput.value;
      await doLookup(status, load);
    });

    scanBtn.addEventListener('click', () => {
      setMsg(status, 'Opening scanner…');
      window.MiniScanner.open();
    });

    clearBtn?.addEventListener('click', () => {
      upcInput.value = '';
      updateLookupBtn();
      setMsg(status, '');
    });

    updateLookupBtn();
    spinner(false, load);
  }

  async function doLookup(statusEl, loadEl){
    setMsg(statusEl, 'Looking up barcode…');
    spinner(true, loadEl);
    try {
      const res = await API.lookup(state.upc);
      if (res?.found) {
        state.item = normalizeItemFromSheet(res.item || {});
        navigate('screenResults');
        setTimeout(renderResults, 0);
      } else {
        state.item = null;
        navigate('screenNew');
      }
      setMsg(statusEl, '');
    } catch(err){
      console.error('[lookup error]', err);
      setMsg(statusEl, 'Lookup failed. Try again.', 'error');
    } finally {
      spinner(false, loadEl);
    }
  }

  window.addEventListener('upc-scanned', async ev => {
    const upc = ev.detail?.upc || '';
    const status = $('#launchInfo');
    const load = $('#launchLoad');
    const input = $('#upcInput');
    const lookupBtn = $('#lookupBtn');

    if (input) input.value = upc;
    if (lookupBtn) lookupBtn.disabled = !isValidUPC(upc);
    setMsg(status, 'Scanned ✓ Looking up…', 'success');
    spinner(true, load);

    try {
      state.upc = upc;
      await doLookup(status, load);
    } catch (e) {
      console.error(e);
      setMsg(status, 'Scan failed. Try again.', 'error');
    } finally {
      spinner(false, load);
    }
  });

  window.addEventListener('upc-scan-canceled', () => {
    setMsg($('#launchInfo'), 'Scanner closed.');
  });

  function wireNewItem(){
    const frontBtn = $('#frontBtn');
    const frontPreview = $('#frontPreview');
    const ingBtn = $('#ingBtn');
    const ingPreview = $('#ingPreview');
    const nextBtn = $('#nextToIngredients');
    const ingredientsBlock = $('#ingredientsBlock');

    let frontStream, ingStream;

    frontBtn?.addEventListener('click', async () => {
      if (frontStream) stopStream(frontStream);
      frontStream = await openCameraWithPreview(frontPreview, async (dataUrl) => {
        state.photos.front = dataUrl;
        frontPreview.src = dataUrl;
        frontPreview.classList.remove('hidden');
        ingredientsBlock?.classList.remove('hidden');
        checkNextReady();
      });
    });

    ingBtn?.addEventListener('click', async () => {
      if (ingStream) stopStream(ingStream);
      ingStream = await openCameraWithPreview(ingPreview, async (dataUrl) => {
        state.photos.ingredients = dataUrl;
        ingPreview.src = dataUrl;
        ingPreview.classList.remove('hidden');
        checkNextReady();
      });
    });

    function checkNextReady(){
      const hasFront = !!state.photos.front;
      const hasIng = !!state.photos.ingredients;
      if (hasFront && hasIng) {
        nextBtn?.classList.remove('hidden');
      }
    }

    function stopStream(stream){
      stream?.getTracks().forEach(track => track.stop());
    }
  }

  async function openCameraWithPreview(previewElement, onCapture){
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });

    const video = document.createElement('video');
    video.srcObject = stream;
    video.setAttribute('playsinline', '');
    video.muted = true;
    video.autoplay = true;
    video.style.width = '100%';
    video.style.borderRadius = '12px';

    const captureBtn = document.createElement('button');
    captureBtn.textContent = 'Take Photo';
    captureBtn.className = 'btn';
    captureBtn.style.marginTop = '1rem';

    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'Cancel';
    cancelBtn.className = 'btn secondary';
    cancelBtn.style.marginLeft = '0.5rem';

    const container = previewElement.parentElement;
    previewElement.classList.add('hidden');
    container.appendChild(video);
    container.appendChild(captureBtn);
    container.appendChild(cancelBtn);

    return new Promise(resolve => {
      captureBtn.addEventListener('click', () => {
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
        stopStream(stream);
        container.removeChild(video);
        container.removeChild(captureBtn);
        container.removeChild(cancelBtn);
        onCapture(dataUrl);
        resolve(null);
      });

      cancelBtn.addEventListener('click', () => {
        stopStream(stream);
        container.removeChild(video);
        container.removeChild(captureBtn);
        container.removeChild(cancelBtn);
        resolve(null);
      });
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    wireGlobal();
    wireLaunch();
    wireNewItem(); // ← required for photo capture
    navigate('screenLaunch');
  });
})();
</script>