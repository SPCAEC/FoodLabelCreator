<script>
/**
 * App controller (finalized with autofocus + cleanup)
 * - Handles barcode scan, lookup, photo capture
 * - Launches camera with autofocus for ingredients only
 * - Sends data to API, renders review screen
 */

(function(){
  const $ = sel => document.querySelector(sel);
  const $$ = sel => [...document.querySelectorAll(sel)];

  const state = {
    upc: '',
    item: null,
    exp: '',
    photos: { front: null, ingredients: null },
    pdf: { url: '', id: '' },
    needs: { ingredients: false }
  };

  const isValidUPC = v => /^\d{12}$/.test(String(v || '').trim());
  const isValidDate = v => /^(0[1-9]|1[0-2])\/(0[1-9]|[12]\d|3[01])\/\d{4}$/.test(String(v||''));

  function setMsg(el, text, type){
    if (!el) return;
    el.textContent = text || '';
    el.className = 'msg';
    if (type) el.classList.add(type);
  }

  function spinner(on, el){
    if (el) {
      el.toggleAttribute('hidden', !on);
      el.style.display = on ? 'inline-block' : 'none';
    }
  }

  function navigate(id){
    $$('.screen').forEach(s => s.classList.remove('active'));
    const el = document.getElementById(id);
    if (el) {
      el.classList.add('active');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  }

  function resetApp(){
    Object.assign(state, {
      upc: '', item: null, exp: '',
      photos: { front: null, ingredients: null },
      pdf: { url: '', id: '' },
      needs: { ingredients: false }
    });

    $('#upcInput').value = '';
    $('#lookupBtn').disabled = true;
    navigate('screenLaunch');
  }

  function wireGlobal(){
    $$('.startOver').forEach(btn => btn.addEventListener('click', resetApp));
  }

  function wireLaunch(){
    const upcInput = $('#upcInput');
    const lookupBtn = $('#lookupBtn');
    const scanBtn = $('#scanBtn');
    const clearBtn = $('#clearBtn');
    const status = $('#launchInfo');
    const load = $('#launchLoad');

    function updateLookupBtn(){
      lookupBtn.disabled = !isValidUPC(upcInput.value);
    }

    upcInput.addEventListener('input', () => {
      upcInput.value = upcInput.value.replace(/\D/g, '').slice(0, 12);
      updateLookupBtn();
    });

    lookupBtn.addEventListener('click', async () => {
      if (lookupBtn.disabled) return;
      state.upc = upcInput.value;
      await doLookup(status, load);
    });

    scanBtn.addEventListener('click', () => {
      setMsg(status, 'Opening scanner…');
      window.MiniScanner.open();
    });

    clearBtn?.addEventListener('click', () => {
      upcInput.value = '';
      updateLookupBtn();
      setMsg(status, '');
    });

    updateLookupBtn();
    spinner(false, load);
  }

  async function doLookup(statusEl, loadEl){
    setMsg(statusEl, 'Looking up barcode…');
    spinner(true, loadEl);
    try {
      const res = await API.lookup(state.upc);
      if (res?.found) {
        state.item = normalizeItemFromSheet(res.item || {});
        navigate('screenResults');
        setTimeout(renderResults, 0);
      } else {
        state.item = null;
        navigate('screenNew');
      }
      setMsg(statusEl, '');
    } catch(err){
      console.error('[lookup error]', err);
      setMsg(statusEl, 'Lookup failed. Try again.', 'error');
    } finally {
      spinner(false, loadEl);
    }
  }

  function normalizeItemFromSheet(item) {
    return {
      upc: String(item.upc || '').trim(),
      brand: String(item.brand || '').trim(),
      productName: String(item.productName || '').trim(),
      flavor: String(item.flavor || '').trim(),
      species: String(item.species || '').trim(),
      lifestage: String(item.lifestage || '').trim(),
      ingredients: String(item.ingredients || '').trim(),
      type: String(item.type || '').trim()
    };
  }

  function renderReview() {
    const item = state.item || {};
    $('#revExp').value = state.exp || '';
    $('#revSpecies').value = item.species || 'Dog';
    $('#revStage').value = item.lifestage || 'Adult';
    $('#revBrand').value = item.brand || '';
    $('#revName').value = item.productName || '';
    $('#revFlavor').value = item.flavor || '';
    $('#revIngredients').value = item.ingredients || '';
    $('#revTreatFood').value = item.type || '';
  }

  function wireNewItem(){
    const frontBtn = $('#frontBtn');
    const frontPreview = $('#frontPreview');
    const ingBtn = $('#ingredientsBtn');
    const ingPreview = $('#ingredientsPreview');
    const ingBlock = $('#ingredientsBlock');
    const nextBtn = $('#nextToIngredients');
    const msg = $('#newStatus');
    const spinnerEl = $('#newLoad');

    function stopStream(stream) {
      if (stream) stream.getTracks().forEach(track => track.stop());

      if (state.photos.front && !state.photos.ingredients) {
        ingBlock?.classList.remove('hidden');
      }
    }

    function launchCamera({ onCapture, autofocus = false }) {
      const overlay = document.createElement('div');
      overlay.className = 'camera-overlay';
      overlay.innerHTML = `
        <video autoplay playsinline></video>
        <button class="btn take">Take Photo</button>
        <button class="btn secondary cancel">Cancel</button>
      `;
      document.body.appendChild(overlay);

      const video = overlay.querySelector('video');
      const takeBtn = overlay.querySelector('.take');
      const cancelBtn = overlay.querySelector('.cancel');

      const constraints = {
        video: {
          facingMode: 'environment',
          ...(autofocus ? { focusMode: 'continuous' } : {})
        }
      };

      navigator.mediaDevices.getUserMedia(constraints)
        .then(stream => {
          video.srcObject = stream;

          takeBtn.onclick = () => {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const dataUrl = canvas.toDataURL('image/jpeg');

            stopStream(stream);
            overlay.remove();
            if (onCapture) onCapture(dataUrl);
          };

          cancelBtn.onclick = () => {
            stopStream(stream);
            overlay.remove();
          };
        })
        .catch(err => {
          console.error('Camera error', err);
          setMsg(msg, 'Camera not available', 'error');
        });
    }

    frontBtn?.addEventListener('click', () => {
      frontBtn.classList.add('hidden');
      ingBlock?.classList.add('hidden');
      launchCamera({
        onCapture: dataUrl => {
          frontPreview.src = dataUrl;
          frontPreview.classList.remove('hidden');
          state.photos.front = dataUrl;

          setMsg(msg, 'Processing front photo…', 'success');
          spinner(true, spinnerEl);
          setTimeout(() => {
            setMsg(msg, '');
            spinner(false, spinnerEl);
          }, 1000);

          ingBlock?.classList.remove('hidden');
          checkNextReady();
        }
      });

      setTimeout(() => {
        document.querySelector('.camera-overlay')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 300);
    });

    ingBtn?.addEventListener('click', () => {
      ingBtn.classList.add('hidden');
      launchCamera({
        autofocus: true,
        onCapture: dataUrl => {
          ingPreview.src = dataUrl;
          ingPreview.classList.remove('hidden');
          state.photos.ingredients = dataUrl;

          setMsg(msg, 'Processing ingredients photo…', 'success');
          spinner(true, spinnerEl);
          setTimeout(() => {
            setMsg(msg, '');
            spinner(false, spinnerEl);
          }, 1000);

          checkNextReady();
        }
      });
      setTimeout(() => {
        document.querySelector('.camera-overlay')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 300);
    });

    function checkNextReady(){
      if (state.photos.front && state.photos.ingredients) {
        nextBtn?.classList.remove('hidden');
      }
    }

    nextBtn?.addEventListener('click', async () => {
      if (!state.photos.front || !state.photos.ingredients) return;
      setMsg(msg, 'Extracting label data…', 'success');
      spinner(true, spinnerEl);

      try {
        const extracted = await API.extract({
          upc: state.upc,
          frontDataUrl: state.photos.front,
          ingDataUrl: state.photos.ingredients
        });

        state.item = normalizeItemFromSheet({
          upc: state.upc,
          ...extracted
        });

        navigate('screenReview');
        setTimeout(renderReview, 0);
      } catch (err) {
        console.error('[extract error]', err);
        setMsg(msg, 'AI extraction failed. Please try again.', 'error');
      } finally {
        spinner(false, spinnerEl);
      }
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    wireGlobal();
    wireLaunch();
    wireNewItem();
    navigate('screenLaunch');
  });
})();
</script>