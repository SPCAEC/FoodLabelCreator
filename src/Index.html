<!-- ui/Index.html -->
<!DOCTYPE html>
<html>
<head>
  <base target="_top" />
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>Food Label Creator</title>
  <?!= include_('ui/css.kiosk'); ?>
  <style>
    /* Camera wrapper */
    #cameraWrap { display:none; margin-top:.75rem; }
    #cameraControls { display:flex; gap:.75rem; margin-top:.75rem; }
    #scanPreview { inline-size:100%; block-size:60vh; border-radius:16px; background:#000; }
  </style>
</head>
<body>
  <main class="app">
    <header>
      <h1>Food Label Creator</h1>
      <p class="subtitle">Scan or enter a barcode to get started.</p>
    </header>

    <section id="launch" class="card">
      <p class="msg">Use the “Scan Barcode” button below to launch the camera and scan the barcode on the back of your bag or box. If you can’t scan the barcode, type it into the box below.</p>

      <div class="actions">
        <button id="btnScan" class="btn">Scan Barcode</button>
      </div>

      <div class="field" style="margin-top:1rem">
        <label for="upcInput">Barcode Number (12 digits)</label>
        <input id="upcInput" inputmode="numeric" pattern="\\d{12}" placeholder="000000000000" />
        <div class="msg" id="upcHint">Enter exactly 12 digits.</div>
      </div>

      <div class="actions">
        <button id="btnLookup" class="btn" disabled>Lookup Barcode</button>
        <button id="btnStartOver" class="btn startover">Start Over</button>
      </div>

      <div class="msg" id="status" role="status"></div>

      <!-- Camera preview -->
      <div id="cameraWrap">
        <div id="scanPreview"></div>
        <div id="cameraControls">
          <button id="btnCloseCamera" class="btn ghost">Close Camera</button>
        </div>
      </div>
    </section>

    <section id="next" class="card" style="display:none">
      <div class="spinner"></div> <span>Looking up…</span>
    </section>
  </main>

  <!-- Scandit Web SDK 7.6.1 (ESM via jsDelivr) -->
  <script type="module">
    import * as ScanditCore from "https://cdn.jsdelivr.net/npm/@scandit/web-datacapture-core@7.6.1/+esm";
    import * as ScanditBarcode from "https://cdn.jsdelivr.net/npm/@scandit/web-datacapture-barcode@7.6.1/+esm";

    const CONFIG = <?!= JSON.stringify(CONFIG) ?>;

    const upcInput = document.getElementById('upcInput');
    const btnLookup = document.getElementById('btnLookup');
    const btnScan = document.getElementById('btnScan');
    const btnCloseCamera = document.getElementById('btnCloseCamera');
    const cameraWrap = document.getElementById('cameraWrap');
    const previewDiv = document.getElementById('scanPreview');
    const statusEl = document.getElementById('status');
    const nextCard = document.getElementById('next');
    const launchCard = document.getElementById('launch');

    // --- UI helpers ---
    function setStatus(msg){ statusEl.textContent = msg || ''; }
    function resetLaunch(){
      upcInput.value = '';
      btnLookup.disabled = true;
      setStatus('');
      closeCamera();
      nextCard.style.display = 'none';
      launchCard.style.display = '';
    }

    document.getElementById('btnStartOver').addEventListener('click', resetLaunch);

    // Validate 12 digits
    upcInput.addEventListener('input', () => {
      const ok = /^\d{12}$/.test(upcInput.value.trim());
      btnLookup.disabled = !ok;
    });

    btnLookup.addEventListener('click', () => lookupUPC(upcInput.value.trim()));

    // --- Scandit integration (7.6.1) ---
    let context, view, camera, barcodeCapture;

    async function ensureScanner() {
      if (!CONFIG.enableScandit) throw new Error('Scanner disabled');
      if (context) return;

      // Configure engine location & license
      await ScanditCore.configure({
        licenseKey: CONFIG.scanditLicense,
        engineLocation: "https://cdn.jsdelivr.net/npm/@scandit/web-datacapture-core@7.6.1/engine/"
      }); // must be awaited before using SDK components   [oai_citation:2‡Scandit Documentation](https://docs.scandit.com/sdks/web/add-sdk/?utm_source=chatgpt.com)

      context = await ScanditCore.DataCaptureContext.create();
      view = await ScanditCore.DataCaptureView.create(context);
      view.connectToElement(previewDiv);

      const settings = new ScanditBarcode.BarcodeCaptureSettings();
      // Common retail UPC symbologies
      settings.enableSymbologies([
        ScanditBarcode.Symbology.EAN13UPCA,
        ScanditBarcode.Symbology.UPCE,
        ScanditBarcode.Symbology.EAN8,
        ScanditBarcode.Symbology.CODE128
      ]);

      barcodeCapture = await ScanditBarcode.BarcodeCapture.forContext(context, settings);

      // Single-scan listener: stop after first result
      barcodeCapture.addListener({
        didScan: (_, session) => {
          const newly = session.newlyRecognizedBarcodes;
          if (newly.length > 0) {
            const data = newly[0].data;
            if (data && /^\d{12}$/.test(data)) {
              stopScanner();
              upcInput.value = data;
              btnLookup.disabled = false;
              // Auto-advance as if Lookup pressed
              lookupUPC(data);
            } else {
              setStatus('Scanned code is not a 12-digit UPC.');
            }
          }
        }
      });

      // Camera
      camera = ScanditCore.Camera.default;
      await context.setFrameSource(camera);

      // Recommended settings
      const rec = ScanditCore.CameraSettings.create();
      await camera.applySettings(rec);

      // Attach viewfinder (optional visual cue)
      const viewFinder = new ScanditCore.RectangularViewfinder();
      view.viewfinder = viewFinder;
    }

    async function startScanner() {
      await ensureScanner();
      cameraWrap.style.display = '';
      setStatus('Opening camera…');
      await barcodeCapture.setEnabled(true);
      await camera.switchToDesiredState(ScanditCore.FrameSourceState.On);
      setStatus('Point at the barcode');
    }

    async function stopScanner() {
      if (!camera) return;
      await barcodeCapture.setEnabled(false);
      await camera.switchToDesiredState(ScanditCore.FrameSourceState.Off);
    }

    async function closeCamera() {
      cameraWrap.style.display = 'none';
      await stopScanner();
      setStatus('');
    }

    btnScan.addEventListener('click', async () => {
      try {
        await startScanner();
      } catch (e) {
        setStatus('Could not start camera. Check permissions and try again.');
        console.error(e);
      }
    });

    btnCloseCamera.addEventListener('click', closeCamera);

    // --- Lookup flow ---
    function gotoNext() {
      launchCard.style.display = 'none';
      nextCard.style.display = '';
    }

    function gotoLaunchWithError(msg) {
      nextCard.style.display = 'none';
      launchCard.style.display = '';
      setStatus(msg || 'Error. Please try again.');
    }

    function lookupUPC(upc) {
      gotoNext();
      google.script.run
        .withSuccessHandler(res => {
          if (!res || !res.ok) {
            gotoLaunchWithError(res && res.message ? res.message : 'Lookup failed.');
            return;
          }
          // Route based on found/not found.
          // For Step 1 we just show a status; in Step 2 we’ll navigate to Results or New Item.
          if (res.data && res.data.found) {
            setStatus('Match found. (Next step: Results screen)');
          } else {
            setStatus('No match. (Next step: New Item screen)');
          }
        })
        .withFailureHandler(err => {
          gotoLaunchWithError('Server error during lookup.');
          console.error(err);
        })
        .apiLookup(upc);
    }
  </script>
</body>
</html>